<!DOCTYPE html>
<html lang="en">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>

 <head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <meta name="description" content="Data Dashboard">
   <meta name="author" content="Jack Savage">
   <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
   <link rel="stylesheet" href="static/libs/style.css">
   <title>Data Dashboard</title>
 </head>


 <!-- INFO AND ABOUT SECTIONS -->
 <body>
    <div class="about">
      <h1 style="text-align:center;">VizML Final Project</h1>
      <h4 style="text-align:center;">The code can be found on Github <a href="https://github.com/jeckseveg/interactive_localization">here</a></h4>
      <h4 style="text-align:center;">The StreetAware dataset can be found <a href="https://drive.google.com/drive/folders/1BPtiIF8gBOoZANAGkwDjJUYakpCUYHM1">here</a></h4>
    </div>
    
      <!-- load javascript here -->
    <script src="static/libs/scripts.js"></script>
    <script>
    // get data from flask
    function getData() {
      fetch("/get_data")
        .then(response => response.json())
        .then(data => {
          console.log(data.message + ", " + data.name);
        });
    }
    getData();
    </script>
    <!-- MAIN BODY OF WEB APP -->
    <div class="app-container" id="app_container">
      
      
      <!-- Left section -->
      <div class="left-content" id="left_section">
        <div id="topdown"></div>
        <div class='row'>
          
          <div class="column"><button id="toggle-centroids" activated="True">Toggle Centroids</button></div><!-- >Localize detections</button> -->
          <div class="column"><button id="toggle-ground-points" activated="True" >Toggle Points</button></div>
          <div class="column"><button id="toggle-boxes" activated="False" >Toggle Boxes</button></div>
          
        </div>
        <div class="row">
          <div class="column">
            <div class="slider-container">
              <label for="centroid-slider">Min Centroid Points</label>
              <input type="range" id="centroid-slider" min="1" max="8" value="2" class="slider" >
              <span id="centroid-slider-value">2</span>
            </div>
          </div>
          <div class="column">
            <div class="slider-container">
              <label for="max-dist-slider">Max Clustering Distance</label>
              <input type="range" id="max-dist-slider" min="5" max="70" value="40" class="slider" >
              <span id="max-dist-slider-value">40</span>
            </div>
          </div>
          <div class="column">
            <div class="slider-container">
              <label for="opacity-slider">Ground Point Opacity</label>
              <input type="range" id="opacity-slider" min="0" max="100" value="100" class="slider" >
              <span id="opacity-slider-value">100</span>
            </div>
          </div>
          
        </div>
        <!-- Button controls -->
        <script>
          let opacity = 1.0
          let max_dist = 40
          let centroids_active = true;
          let ground_points_active = true;
          let box_toggler_active = false;
          var centroid_slider = document.getElementById("centroid-slider")
          var centroid_valueSpan = document.getElementById("centroid-slider-value")
          var max_dist_slider = document.getElementById("max-dist-slider")
          var max_dist_valueSpan = document.getElementById("max-dist-slider-value")
          var opacity_slider = document.getElementById("opacity-slider")
          var opacity_valueSpan = document.getElementById("opacity-slider-value")

          // select all buttons and add event listener for each
          var ground_points_button = $("#toggle-ground-points")[0];
          ground_points_button.addEventListener("click", toggle_ground_points)
          var centroid_button = $("#toggle-centroids")[0];
          centroid_button.addEventListener("click", toggle_centroids)
          
          
          // change button color on click
          function toggle_ground_points() {
              // turn on/off
              var ground_points_button = document.getElementById("toggle-ground-points");
              console.log(ground_points_button.getAttribute("activated")==="True")
              if (ground_points_button.getAttribute("activated")==="True"){
                ground_points_button.style.backgroundColor = "#533"
                ground_points_button.setAttribute('activated','False')
                ground_points_active = false
              }
              // turn off/on
              else{
                ground_points_button.style.backgroundColor = "#333"
                ground_points_button.setAttribute('activated','True')
                ground_points_active = true
              }
              updateSVG();
          }
          function toggle_centroids() {
              // turn on/off
              var centroid_button = document.getElementById("toggle-centroids");
              console.log(centroid_button.getAttribute("activated")==="True")
              if (centroid_button.getAttribute("activated")==="True"){
                centroid_button.style.backgroundColor = "#533";
                centroid_button.setAttribute('activated','False');
                centroid_button.style.opacity = 1.0;
                centroids_active = false;
              }
              // turn off/on
              else{
                centroid_button.style.backgroundColor = "#333";
                centroid_button.setAttribute('activated','True');
                centroid_button.style.opacity = 1.0;
                centroids_active = true;
              }
              updateSVG();
          }


          // slider update behavior
          centroid_slider.oninput = function() {
            centroid_valueSpan.textContent = this.value;
            frameUpdateEngine(0);
          };
          max_dist_slider.oninput = function() {
            max_dist_valueSpan.textContent = this.value;
            max_dist=this.value;
            frameUpdateEngine(0);
          };
          opacity_slider.oninput = function() {
            opacity_valueSpan.textContent = this.value;
            opacity = 0.01*this.value;
            updateSVG();
          };

        </script>
        <!-- Build the svg -->
        <script> 
          const colors = ['red','#00CC66','#3399FF','orange','#CC33CC','yellow','white','#ff9999']
          const cameras = [0,1,2,3,4,5,6,7]
          var colorFunc = d3.scaleOrdinal()
                        .domain(cameras)
                        .range(colors);
          const svg = d3.select("div#topdown")
              .append("div")
              // Container class to make it responsive.
              .classed("svg-container", true) 
              .append("svg")
              .attr("id", "svg-id") // svg id
              // Responsive SVG needs these 2 attributes and no width and height attr.
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr("viewBox", "0 0 570 478")
              .classed("svg-content-responsive", true) // Class to make it responsive.
         
              svg.append("image")
              .attr("xlink:href", "../static/data/chase_1/homography_targets/chase_1.png")
              .attr("width","100%")
              .attr("height","100%")
              .attr("id","topdown-image-id");  
              
          const g = svg.append("g")
               .attr("transform",
               "translate(" + 0 + "," + 0 + ")");
          
          // legend
          spaceBetween = 16;
          xStart = 20;
          yStart = 20;
          squareSize = 10;

          svg.append("rect")
            .attr("x",xStart-10)
            .attr("y",yStart-10)
            .attr("height",140)
            .attr("width",50)
            .attr("opacity",0.9)
            .attr("fill","#383838")

          svg.selectAll("legend_markers")
            .data(cameras)
            .enter()
            .append("rect")
            .attr("x", xStart)
            .attr("y", function(d,i){ return yStart + i*spaceBetween}) // 100 is where the first dot appears. 25 is the distance between dots
            .attr("width", squareSize)
            .attr("height", squareSize)
            .style("fill", function(d){ return colorFunc(d)})

          svg.selectAll("mylabels")
            .data(cameras)
            .enter()
            .append("text")
              .attr("x", xStart + 20)
              .attr("y", function(d,i){ return yStart+ 6 + i*(spaceBetween)}) // 100 is where the first dot appears. 25 is the distance between dots
              .style("fill", function(d){ return colorFunc(d)})
              .text(function(d){ return d+1})
              .attr("text-anchor", "left")
              .style("alignment-baseline", "middle")
              .style("font-size", "12px")


               
      </script>
        <script>
          
        </script>
        <br>

      </div>


      <!-- Right section -->
      <div class="right-content" id="right_section">
        <!-- Dynamic Video Section -->
        <div class="video box" style="padding-bottom: 20px;">
          <!-- <canvas id="videoCanvas"></canvas> -->
          <div class='row'>
            <div class='column'>
              <video id="video_1" width="100%" preload="auto" playsinline>
                <!-- <source src="../static/data/chase_1/sensor_1/video/left/left_half.mp4" type="video/mp4"> -->
                <source id="source_1" src="../static/data/chase_1/sensor_1/video/left/left_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class='column'>
              <video id="video_2" width="100%" preload="auto" playsinline>
                <!-- <source src="../static/data/chase_1/sensor_1/video/right/right_half.mp4" type="video/mp4"> -->
                <source id="source_2" src="../static/data/chase_1/sensor_1/video/right/right_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class='column'>
              <video id="video_3" width="100%" preload="auto" playsinline>
                <!-- <source src="../static/data/chase_1/sensor_2/video/left/left_half.mp4" type="video/mp4"> -->
                <source id="source_3" src="../static/data/chase_1/sensor_2/video/left/left_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class='column'>
              <video id="video_4" width="100%" preload="auto" playsinline>
                <!-- <source src="../static/data/chase_1/sensor_2/video/right/right_half.mp4" type="video/mp4"> -->
                <source id="source_4" src="../static/data/chase_1/sensor_2/video/right/right_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
          </div>
          <div class='row'>
            <div class='column'>
              <video id="video_5" width="100%" preload="auto" playsinline>
                <source id="source_5" src="../static/data/chase_1/sensor_3/video/left/left_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class='column'>
              <video id="video_6" width="100%" preload="auto" playsinline>
                <!-- <source src="../static/data/chase_1/sensor_3/video/right/right_half.mp4" type="video/mp4"> -->
                <source id="source_6" src="../static/data/chase_1/sensor_3/video/right/right_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class='column'>
              <video id="video_7" width="100%" preload="auto" playsinline>
                <!-- <source src="../static/data/chase_1/sensor_4/video/left/left_half.mp4" type="video/mp4"> -->
                <source id="source_7" src="../static/data/chase_1/sensor_4/video/left/left_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class='column'>
              <video id="video_8" width="100%" preload="auto" playsinline>
                <!-- <source src="../static/data/chase_1/sensor_4/video/right/right_half.mp4" type="video/mp4"> -->
                <source id="source_8" src="../static/data/chase_1/sensor_4/video/right/right_quarter.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
          </div>
        </div>

        <script type="text/javascript">
          
          // Update source URL
          var box_toggler = document.getElementById("toggle-boxes");
          box_toggler.addEventListener("click", toggle_boxes);
          box_toggler_active = false;
          box_toggler.setAttribute('activated','False');
          box_toggler.style.backgroundColor = "#533";
          
          
          function reload_videos(box_toggler_active) {
            for (let i = 1; i <= 8; i++){
              var video_i = document.getElementById(`video_${i}`);
              var currentTime = video_i.currentTime;
              var src_i = document.getElementById(`source_${i}`);
              var src_path = src_i.src;
              if(box_toggler_active){ // turn on boxes
                src_path = src_path.slice(0, src_path.lastIndexOf(".")) + "_boxes_2.mp4";
              }
              else{ // turn off boxes
                src_path = src_path.slice(0,src_path.indexOf("_boxes_2"))+".mp4"; 
              }

              src_i.src = src_path;
              video_i.load();
              video_i.currentTime = currentTime;
              };
              updateSVG();
            }
          

          function toggle_boxes() {
            // turn off
            var box_toggler = document.getElementById("toggle-boxes")
            console.log(box_toggler.getAttribute("activated")==="True")
            if (box_toggler.getAttribute("activated")==="True"){
              box_toggler_active = false;
              box_toggler.setAttribute('activated','False');
              box_toggler.style.backgroundColor = "#533";
              
              reload_videos(box_toggler_active);
            }
            // turn on
            else{
              box_toggler_active = true;
              box_toggler.setAttribute('activated','True');
              box_toggler.style.backgroundColor = "#333";
              
              reload_videos(box_toggler_active);
            }
            updateSVG();
          }
        </script>
        
        <!-- progress bar / play pause button-->
        <div id="playback">
          <div id="button-wrapper">
            <button id="play-pause"><img id="play-pause-image" src="{{ url_for('static', filename='images/play_button.png') }}"></button>
          </div>
          <div id="scrubber">
            <div id="progress"></div>
          </div>
          <div id="time-display"></div>
        </div>

        <!-- play/pause + scrubbing + video time-->
        <script type="text/javascript">
          const fps = 14.403
          //scrubbing
          $(document).ready(function () {
            var videos = $("video"); 
            var $scrubber = $(scrubber);
            var $progress = $(progress);
            
            for (i = 0; i<videos.length; i++){
              videos[i].addEventListener("timeupdate", videoTimeUpdateHandler);
            }
              
            $scrubber.bind("mousedown", scrubberMouseDownHandler);
            
            function videoTimeUpdateHandler(e) { 
                var video = videos[0]; 
                var percent = video.currentTime / video.duration;
                updateProgressWidth(percent);     
            }
            
            function scrubberMouseDownHandler(e) { 
                var $this = $(this);
                var x = e.pageX - $this.offset().left;
                var percent = x / $this.width();
                updateProgressWidth(percent);
                updateVideoTime(percent);
            }
            
            function updateProgressWidth(percent) { 
                $progress.width((percent * 100) + "%");
            }
            
            function updateVideoTime(percent) {
              // apply this one to all
              for (i = 0; i<videos.length; i++){
                videos[i].currentTime = percent * videos[i].duration;
              }
            }
          });

        // display video time //
        var video_1 = $("video")[0]
        var time_display = document.getElementById("time-display");
        
        function updateTimeDisplay() {
          const currentTime = video_1.currentTime;
          const totalDuration = video_1.duration;
          const formattedTime = formatTime(currentTime, totalDuration);  // Implement formatTime function
          time_display.textContent = formattedTime;
        }

        function formatTime(currentTime, totalDuration) {
          // Convert seconds to integer values for minutes and seconds
          const currentMinutes = Math.floor(currentTime / 60);
          const currentSeconds = Math.floor(currentTime % 60);

          // Convert seconds to integer values for total minutes and seconds
          const totalMinutes = Math.floor(totalDuration / 60);
          const totalSeconds = Math.floor(totalDuration % 60);

          // Format minutes and seconds with zero-padding using String.padStart()
          const formattedCurrentMinutes = String(currentMinutes).padStart(2, "0");
          const formattedCurrentSeconds = String(currentSeconds).padStart(2, "0");
          const formattedTotalMinutes = String(totalMinutes).padStart(2, "0");
          const formattedTotalSeconds = String(totalSeconds).padStart(2, "0");

          // Return the formatted time string
          return `${formattedCurrentMinutes}:${formattedCurrentSeconds} / ${formattedTotalMinutes}:${formattedTotalSeconds}`;
        }

        // create payload for flask
        // get location and active sensor info
        var new_buttons = document.querySelectorAll('.button-container button');
        var activatedValues = Array.from(new_buttons).map(button => button.getAttribute("activated"));
        
        let graph_data = 0;
        
        // function to run every frame
        async function frameUpdateEngine(timestamp) {
          const startTime = performance.now();
          var min_points = parseInt(document.getElementById("centroid-slider").value)
          currentFrame = Math.floor(fps*video_1.currentTime) // store current frame for operations
          //if(currentFrame%5 === 0){
            // create payload for flask
            var new_buttons = document.querySelectorAll('.button-container button');
            var activatedValues = Array.from(new_buttons).map(button => button.getAttribute("activated"));
            
            var json_payload = JSON.stringify({
              max_distance : max_dist,
              frame_number: currentFrame,
              activated_cameras: activatedValues,
              location: "chase_1",
              min_points: min_points
            });

            // print frame number
            console.log(`Current Frame: ${currentFrame}`);
            console.log(json_payload)

            // send payload
            graph_data = await sendAndReceiveData(json_payload)
            console.log("graph data")
            console.log(graph_data)
            
            updateSVG() // update the svg
          //}
          // cleanse the video frame callback
          //video_1.cancelVideoFrameCallback(frameUpdateEngine);
          video_1.requestVideoFrameCallback(frameUpdateEngine);
          const endTime = performance.now();
          console.log("Execution time:", endTime - startTime, "milliseconds");
          
        }
        

        async function updateSVG() {
          
          console.log(svg)
          console.log("^ svg")
          var nodeArray = Array.from(Object.values(graph_data.nodes));
          var nodeObject = graph_data.nodes
          var edgeArray = graph_data.edges
          var centroidArray = graph_data.centroids
          var x_adjust = 137
          var y_adjust = 92          

          // clear svg
          svg.selectAll("circle").remove();
          svg.selectAll("path").remove();

          
          // only if ground points are being displayed
          if(ground_points_active){
            // scatter points for ground point nodes
            g.selectAll("dot")
              .data(nodeArray)
              .enter()
              .append("circle")
                .attr("cx", function (d) { return d.position[0]+x_adjust; } )
                .attr("cy", function (d) {return d.position[1]+y_adjust;} )
                .attr("r", 4)
                .attr("fill",function (d) { return d.color; } )
                .style('opacity', opacity);

            // paths for edges
            var link = d3.linkHorizontal()
                  .source(function(d) {
                    //console.log("line");
                    //console.log(nodeObject[d[0]]['position']);
                    //console.log([nodeObject[d[0]]['position'][0]+x_adjust, nodeObject[d[0]]['position'][1]+y_adjust])
                      return [nodeObject[d[0]]['position'][0]+x_adjust, nodeObject[d[0]]['position'][1]+y_adjust];
                  })
                  .target(function(d) {
                    //console.log(d)
                    //console.log([nodeObject[d[1]]['position'][0]+x_adjust, nodeObject[d[1]]['position'][1]+y_adjust])
                      return [nodeObject[d[1]]['position'][0]+x_adjust, nodeObject[d[1]]['position'][1]+y_adjust];
                  });
            d3.select("#svg-id") 
              .selectAll("path")
              .data(edgeArray)
              .join("path")
              .attr("stroke-width", 5)
              .attr("d", link)
              .style("opacity",opacity)
              //.classed("link", true);
          }

          if (centroids_active){
            // code to draw the centroids here
            // code to draw the centroids here
            g.selectAll("centroid")
              .data(centroidArray)
              .enter()
              .append("circle")
                .attr("cx", function (d) { return d[0]+x_adjust; } )
                .attr("cy", function (d) {return d[1]+y_adjust;} )
                .attr("r", 7)
                .attr("fill","white")
                .style("stroke", "black")  // Add stroke for outline
                .style("stroke-width", 2)  // Adjust stroke width as needed
                .style('opacity', 1);
          }
        };

        var added = false
        // event listeners for framewise activity
        video_1.addEventListener('play', () => {
          if (!added){
            video_1.requestVideoFrameCallback(frameUpdateEngine);
            added = true
          } 
        });

        
        video_1.addEventListener("timeupdate", updateTimeDisplay);

        // play/pause functionality
        var videos = $("video");
        var playButton = document.getElementById("play-pause");
        var playImage = document.getElementById("play-pause-image");
        var playIconPath = "{{ url_for('static', filename='images/play_button.png') }}";  
        var pauseIconPath = "{{ url_for('static', filename='images/pause_button.png') }}"; 
        let isPlaying = false;
                
        playButton.addEventListener("click", function() {
          if (isPlaying) {
            for (i = 0; i<videos.length; i++){
                videos[i].pause();
              }
            video_1.cancelVideoFrameCallback(frameUpdateEngine);
            playImage.src = playIconPath;
          } else {
            for (i = 0; i<videos.length; i++){
                videos[i].play();
                
              }
            playImage.src = pauseIconPath; // update play / pause button
          }
          frameUpdateEngine(0);
          isPlaying = !isPlaying;
        });
      </script>
        <!-- camera selector -->
        <div class ="button-container">
          <button activated="True">View 1</button>
          <button activated="True">View 2</button>
          <button activated="True">View 3</button>
          <button activated="True">View 4</button>
          <button activated="True">View 5</button>
          <button activated="True">View 6</button>
          <button activated="True">View 7</button>
          <button activated="True">View 8</button>
          <form>
            <label for="playback_label">Playback Speed:</label>
            <select name="playback_speed" id="playback_speed" onchange="updatePlaybackSpeed()">
              <option value=1.0>1.00x</option>
              <option value=0.75>0.75x</option>
              <option value=0.5>0.50x</option>
              <option value=0.25>0.25x</option>
            </select>
          </form>
          <script>
            // select all buttons and add event listener for each
            const buttons = document.querySelectorAll('.button-container button');
            for(var i = 0; i < buttons.length; i++) {
              buttons[i].addEventListener("click", bindClick(i));
            }
            // change button color on click
            function bindClick(i) {
              return function() {
                // turn on/off

                if (buttons[i].style.backgroundColor!='rgb(85, 51, 51)'){
                buttons[i].style.backgroundColor = "#533"
                buttons[i].setAttribute('activated','False')
                videos[i].style.opacity = 0.5
                }
                // turn off/on
                else{
                buttons[i].style.backgroundColor = "#333"
                buttons[i].setAttribute('activated','True')
                videos[i].style.opacity = 1.0
                }
                frameUpdateEngine(0);
              };
            }

            
            function updatePlaybackSpeed(){
              var selectedSpeed = document.getElementById("playback_speed").value;
              console.log(selectedSpeed)
              for(var i = 0; i < videos.length; i++){
                videos[i].playbackRate = selectedSpeed
              }
              
            }
          </script>
        </div>
      </div>
    </div> 
  </div>
</body>
</html>